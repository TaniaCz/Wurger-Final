import { useState, useEffect } from 'react';

const Reports = () => {
    const [sales, setSales] = useState([]);
    const [products, setProducts] = useState([]);
    const [dateRange, setDateRange] = useState({
        start: new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0],
        end: new Date().toISOString().split('T')[0]
    });

    useEffect(() => {
        fetchData();
    }, [dateRange]);

    const fetchData = async () => {
        try {
            const [salesRes, productsRes] = await Promise.all([
                fetch('http://localhost:8080/api/ventas'),
                fetch('http://localhost:8080/api/productos')
            ]);
            const salesData = await salesRes.json();
            const productsData = await productsRes.json();

            setSales(salesData);
            setProducts(productsData);
        } catch (error) {
            console.error('Error fetching data:', error);
        }
    };

    const getFilteredSales = () => {
        if (!Array.isArray(sales)) return [];
        return sales.filter(sale => {
            if (!sale || !sale.fecha) return false;
            const saleDate = new Date(sale.fecha);
            // Check if date is valid
            if (isNaN(saleDate.getTime())) return false;
            return saleDate >= new Date(dateRange.start) && saleDate <= new Date(dateRange.end);
        });
    };

    const getTotalRevenue = () => {
        return getFilteredSales().reduce((sum, sale) => {
            const val = parseFloat(sale.totalVenta || sale.total);
            return sum + (isNaN(val) ? 0 : val);
        }, 0);
    };

    const getBestSellingProducts = () => {
        const productSales = {};
        const filtered = getFilteredSales();

        filtered.forEach(sale => {
            if (Array.isArray(sale.detalles)) {
                sale.detalles.forEach(detalle => {
                    if (!detalle || !detalle.producto) return;

                    const productId = detalle.producto.id;
                    const productName = detalle.producto.nombreProducto || detalle.producto.nombre || 'Desconocido';

                    if (productId) {
                        if (!productSales[productId]) {
                            productSales[productId] = {
                                name: productName,
                                quantity: 0,
                                revenue: 0
                            };
                        }
                        const qty = parseInt(detalle.cantidad) || 0;
                        const sub = parseFloat(detalle.subtotal) || 0;
                        productSales[productId].quantity += qty;
                        productSales[productId].revenue += sub;
                    }
                });
            }
        });

        return Object.entries(productSales)
            .map(([id, data]) => ({ id, ...data }))
            .sort((a, b) => b.quantity - a.quantity)
            .slice(0, 5);
    };

    const getSalesByStatus = () => {
        const statusCount = {};
        getFilteredSales().forEach(sale => {
            const status = sale.estado || 'Desconocido';
            statusCount[status] = (statusCount[status] || 0) + 1;
        });
        return statusCount;
    };

    const formatCOP = (value) => {
        if (value === null || value === undefined || isNaN(value)) return '$ 0';
        return new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0
        }).format(value);
    };

    const downloadCSV = () => {
        const filtered = getFilteredSales();
        if (filtered.length === 0) {
            alert("No hay datos para exportar");
            return;
        }

        // CSV Header
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "ID Venta,Fecha,Cliente,Estado,Total,Productos\n";

        // CSV Rows
        filtered.forEach(sale => {
            const productos = sale.detalles?.map(d =>
                `${d.cantidad}x ${d.producto?.nombreProducto || 'Producto'}`
            ).join('; ') || '';

            const row = [
                sale.id,
                new Date(sale.fecha).toLocaleDateString(),
                sale.usuario?.email || 'N/A',
                sale.estado,
                (sale.totalVenta || sale.total || 0),
                `"${productos}"` // Quote to handle commas/semicolons
            ].join(",");
            csvContent += row + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);

        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Ventas');

        // Add logo
        try {
            const response = await fetch('/logo.png');
            const blob = await response.blob();
            const reader = new FileReader();
            const base64 = await new Promise((resolve) => {
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(blob);
            });

            const logoId = workbook.addImage({
                base64: base64,
                extension: 'png',
            });
            worksheet.addImage(logoId, 'A1:B4');
        } catch (e) {
            console.warn('Logo not loaded');
        }

        // Title
        worksheet.mergeCells('A6:F6');
        worksheet.getCell('A6').value = 'Reporte de Ventas - Wurger';
        worksheet.getCell('A6').font = { size: 16, bold: true };
        worksheet.getCell('A6').alignment = { horizontal: 'center' };

        // Date range
        worksheet.mergeCells('A7:F7');
        worksheet.getCell('A7').value = `Período: ${dateRange.start} a ${dateRange.end}`;
        worksheet.getCell('A7').alignment = { horizontal: 'center' };

        // Summary
        worksheet.getCell('A9').value = 'Total Ventas:';
        worksheet.getCell('B9').value = formatCOP(totalRevenue);
        worksheet.getCell('A10').value = 'Número de Ventas:';
        worksheet.getCell('B10').value = filteredSales.length;

        // Best-selling products
        worksheet.getCell('A12').value = 'Productos Más Vendidos';
        worksheet.getCell('A12').font = { size: 14, bold: true };

        worksheet.addRow(['Producto', 'Cantidad', 'Ingresos']);
        worksheet.getRow(13).font = { bold: true };

        bestSelling.forEach(p => {
            worksheet.addRow([p.name, p.quantity, formatCOP(p.revenue)]);
        });

        // Auto-width columns
        worksheet.columns.forEach(column => {
            column.width = 20;
        });

        // Save
        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), `reporte-ventas-wurger-${dateRange.start}.xlsx`);
    };

    const filteredSales = getFilteredSales();
    const totalRevenue = getTotalRevenue();
    const bestSelling = getBestSellingProducts();
    const salesByStatus = getSalesByStatus();

    return (
        <div className="container-fluid">
            <div className="d-flex justify-content-between align-items-center mb-4">
                <h2>Reportes y Estadísticas</h2>
                <div className="btn-group">
                    <button className="btn btn-danger" onClick={downloadPDF}>
                        <i className="bi bi-file-pdf me-2"></i>Exportar PDF
                    </button>
                    <button className="btn btn-success" onClick={downloadExcel}>
                        <i className="bi bi-file-excel me-2"></i>Exportar Excel
                    </button>
                    <button className="btn btn-secondary" onClick={downloadCSV}>
                        <i className="bi bi-filetype-csv me-2"></i>CSV
                    </button>
                </div>
            </div>

            {/* Date Range Filter */}
            <div className="card mb-4">
                <div className="card-body">
                    <div className="row">
                        <div className="col-md-4">
                            <label className="form-label">Fecha Inicio</label>
                            <input
                                type="date"
                                className="form-control"
                                value={dateRange.start}
                                onChange={(e) => setDateRange({ ...dateRange, start: e.target.value })}
                            />
                        </div>
                        <div className="col-md-4">
                            <label className="form-label">Fecha Fin</label>
                            <input
                                type="date"
                                className="form-control"
                                value={dateRange.end}
                                onChange={(e) => setDateRange({ ...dateRange, end: e.target.value })}
                            />
                        </div>
                    </div>
                </div>
            </div>

            {/* Summary Cards */}
            <div className="row mb-4">
                <div className="col-md-3">
                    <div className="card bg-primary text-white">
                        <div className="card-body">
                            <h6>Total Ventas</h6>
                            <h3>{formatCOP(totalRevenue)}</h3>
                        </div>
                    </div>
                </div>
                <div className="col-md-3">
                    <div className="card bg-success text-white">
                        <div className="card-body">
                            <h6>Pedidos</h6>
                            <h3>{filteredSales.length}</h3>
                        </div>
                    </div>
                </div>
                <div className="col-md-3">
                    <div className="card bg-info text-white">
                        <div className="card-body">
                            <h6>Productos</h6>
                            <h3>{products.length}</h3>
                        </div>
                    </div>
                </div>
                <div className="col-md-3">
                    <div className="card bg-warning text-white">
                        <div className="card-body">
                            <h6>Promedio/Pedido</h6>
                            <h3>{formatCOP(filteredSales.length > 0 ? (totalRevenue / filteredSales.length) : 0)}</h3>
                        </div>
                    </div>
                </div>
            </div>

            <div className="row">
                {/* Best Selling Products */}
                <div className="col-md-6 mb-4">
                    <div className="card">
                        <div className="card-body">
                            <h5>Productos Más Vendidos</h5>
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>Cantidad</th>
                                        <th>Ingresos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {bestSelling.map((product, index) => (
                                        <tr key={index}>
                                            <td>{product.name}</td>
                                            <td>{product.quantity}</td>
                                            <td>{formatCOP(product.revenue)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                {/* Sales by Status */}
                <div className="col-md-6 mb-4">
                    <div className="card">
                        <div className="card-body">
                            <h5>Pedidos por Estado</h5>
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th>Estado</th>
                                        <th>Cantidad</th>
                                        <th>Porcentaje</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {Object.entries(salesByStatus).map(([status, count]) => (
                                        <tr key={status}>
                                            <td>{status}</td>
                                            <td>{count}</td>
                                            <td>{((count / filteredSales.length) * 100).toFixed(1)}%</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default Reports;
